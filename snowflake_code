CREATE DATABASE IF NOT EXISTS TESTDB;
USE DATABASE TESTDB;

CREATE SCHEMA IF NOT EXISTS ECOMMERCE;
USE SCHEMA ECOMMERCE;

CREATE OR REPLACE TABLE GOV_DATA (
  month STRING,
  year STRING,
  products STRING,
  quantity_000_metric_tonnes_ STRING,
  updated_date STRING
);

CREATE OR REPLACE FILE FORMAT json_format
TYPE = 'JSON'
STRIP_OUTER_ARRAY = TRUE;

 CREATE OR REPLACE STORAGE INTEGRATION MY_S3_INTEGRATION
 TYPE = EXTERNAL_STAGE
 STORAGE_PROVIDER = S3
 ENABLED = TRUE
 STORAGE_AWS_ROLE_ARN = 'arn:aws:iam::525096286342:role/MySnowflakeS3AccessRole'
 STORAGE_ALLOWED_LOCATIONS = ('s3://govdata-output/');

DESC INTEGRATION MY_S3_INTEGRATION;

CREATE OR REPLACE STAGE govdata_stage
  URL = 's3://govdata-output/data/'
  STORAGE_INTEGRATION = MY_S3_INTEGRATION
  FILE_FORMAT = (TYPE = JSON);

LIST @govdata_stage;

COPY INTO TESTDB.ECOMMERCE.GOV_DATA FROM @govdata_stage
FILE_FORMAT = (FORMAT_NAME = json_format)
PATTERN = '.*part.*\\.json'
MATCH_BY_COLUMN_NAME = CASE_INSENSITIVE;

CREATE OR REPLACE TABLE TESTDB.ECOMMERCE.GOV_DATA_SORTED AS
SELECT * FROM TESTDB.ECOMMERCE.GOV_DATA ORDER BY TO_NUMBER(year);
